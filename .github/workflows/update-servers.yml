name: Update Configs Hourly

on:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [ main ]
    # paths-ignore:
    #   - 'githubmirror/merged.txt'
    #   - 'githubmirror/wl.txt'
    #   - 'githubmirror/selected.txt'
    #   - 'README.md'
  workflow_dispatch:
    inputs:
      folder_name:
        description: '–ò–º—è –ø–∞–ø–∫–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤'
        required: false
        default: 'confs'

  

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: write
    
    steps:
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub requests urllib3
    
    - name: üöÄ Run merge script
      env:
        MY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OUTPUT_DIR: ${{ github.event.inputs.folder_name || 'githubmirror' }}
      run: |
        echo "üïê –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞..."
        echo "üìÅ –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–∞–ø–∫–∞: $OUTPUT_DIR"
        python scripts/simple_merge.py
    
    - name: üíæ Commit and push changes
      env:
        OUTPUT_DIR: ${{ github.event.inputs.folder_name || 'githubmirror' }}
      run: |
        echo "üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
        
        if [ -f "$OUTPUT_DIR/merged.txt" ]; then
          CONFIG_COUNT=$(grep -c '^v[lm]ess://' "$OUTPUT_DIR/merged.txt" 2>/dev/null || echo "0")
          echo "üìä –ö–æ–Ω—Ñ–∏–≥–æ–≤ –≤ merged.txt: $CONFIG_COUNT"
        fi
        
        if [ -f "$OUTPUT_DIR/wl.txt" ]; then
          WL_CONFIG_COUNT=$(grep -c '^v[lm]ess://' "$OUTPUT_DIR/wl.txt" 2>/dev/null || echo "0")
          echo "üõ°Ô∏è –ö–æ–Ω—Ñ–∏–≥–æ–≤ –≤ wl.txt: $WL_CONFIG_COUNT"
        fi
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config --local pull.rebase true
        
        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏
        if [ -d "$OUTPUT_DIR" ]; then
          echo "üìÅ –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏: $OUTPUT_DIR"
          git add "$OUTPUT_DIR"/*
        fi
        
        # –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º README
        git add README.md
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if git diff --cached --quiet; then
          echo "üîÑ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          exit 0
        fi
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç
        MOSCOW_TIME=$(TZ='Europe/Moscow' date '+%H:%M | %d.%m.%Y')
        git commit -m "ü§ñ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $MOSCOW_TIME"
        
        # –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º..."
        
        # –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—ã—Ç–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å pull —Å rebase
        if git pull --rebase origin main; then
          echo "‚úÖ Rebase —É—Å–ø–µ—à–µ–Ω"
        else
          echo "‚ö†Ô∏è Rebase –Ω–µ —É–¥–∞–ª—Å—è, –æ—Ç–º–µ–Ω—è–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Å–ª–∏—è–Ω–∏—è"
          git rebase --abort
          git pull origin main --strategy-option ours
        fi
        
        # –ü—ã—Ç–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å push
        echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
        MAX_RETRIES=3
        RETRY_DELAY=10
        
        for i in $(seq 1 $MAX_RETRIES); do
          echo "–ü–æ–ø—ã—Ç–∫–∞ $i –∏–∑ $MAX_RETRIES..."
          
          if git push origin main; then
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
            break
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ, –ø–æ–ø—ã—Ç–∫–∞ $i –Ω–µ —É–¥–∞–ª–∞—Å—å"
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "‚è≥ –ñ–¥–µ–º $RETRY_DELAY —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π..."
              sleep $RETRY_DELAY
              
              # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
              echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
              git pull origin main --rebase
            else
              echo "üí• –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å"
              exit 1
            fi
          fi
        done
