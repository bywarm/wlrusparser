name: Update Server List

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¸Ğ· Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ° GitHub
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/update-servers.yml'

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30 
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    env:
      TZ: 'Europe/Moscow'
    
    steps:
    - name: â¬‡ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub
        pip install urllib3
        pip install requests
        echo "âœ… Dependencies installed"
    
    - name: ğŸ”§ Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global core.autocrlf false
    
    - name: ğŸš€ Run server checker script
      env:
        MY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MAX_WORKERS: 50
      run: |
        echo "ğŸ• Current time in UTC: $(date)"
        echo "ğŸ• Current time in Moscow: $(TZ='Europe/Moscow' date)"
        echo "ğŸš€ Starting server check..."
        python scripts/server_checker.py
        echo "âœ… Script completed"
    
    - name: ğŸ“Š Display results
      run: |
        echo "ğŸ“‹ Checking results..."
        if [ -f "confs/good.txt" ]; then
          GOOD_COUNT=$(grep -c '^v[lm]ess://' confs/good.txt || echo "0")
          echo "âœ… Good servers: $GOOD_COUNT"
        else
          echo "âŒ good.txt not found"
        fi
        
        if [ -f "confs/bad.txt" ]; then
          BAD_COUNT=$(grep -c '^v[lm]ess://' confs/bad.txt || echo "0")
          echo "âŒ Bad servers: $BAD_COUNT"
        else
          echo "âŒ bad.txt not found"
        fi
    
    - name: ğŸ’¾ Commit changes
      if: always()
      run: |
        echo "ğŸ’¾ Committing changes..."
        git add -A
        git status
        
        if git diff --cached --quiet; then
          echo "ğŸ”„ No changes to commit"
        else
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾ ĞœĞ¾ÑĞºĞ²Ğµ
          MOSCOW_TIME=$(TZ='Europe/Moscow' date '+%H:%M | %d.%m.%Y')
          git commit -m "ğŸ¤– ĞĞ²Ñ‚Ğ¾-Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: $MOSCOW_TIME"
          
          # ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ push Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ°Ğ¼Ğ¸
          for i in {1..3}; do
            echo "ğŸ“¤ Push attempt $i..."
            if git push; then
              echo "âœ… Push successful"
              break
            else
              echo "âŒ Push failed, retrying..."
              sleep 5
              git pull --rebase
            fi
          done
        fi
    
    - name: ğŸ“ Update workflow status
      if: always()
      run: |
        echo "ğŸ Workflow completed at $(date)"
        echo "ğŸ• Moscow time: $(TZ='Europe/Moscow' date '+%H:%M | %d.%m.%Y')"
