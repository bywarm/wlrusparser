name: Update Configs Hourly

on:
  schedule:
    # –ö–∞–∂–¥—ã–π —á–∞—Å –≤ 0 –º–∏–Ω—É—Ç
    - cron: '0 * * * *'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches: [ main ]

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: write
    
    steps:
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@v4
    
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub requests urllib3
    
    - name: üöÄ Run merge script
      env:
        MY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üïê –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞..."
        python scripts/simple_merge.py
    
    - name: üíæ Commit changes
      run: |
        echo "üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
        
        if [ -f "githubmirror/merged.txt" ]; then
          CONFIG_COUNT=$(grep -c '^v[lm]ess://' githubmirror/merged.txt 2>/dev/null || echo "0")
          echo "üìä –ö–æ–Ω—Ñ–∏–≥–æ–≤ –≤ merged.txt: $CONFIG_COUNT"
        fi
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add githubmirror/merged.txt README.md
        
        if git diff --cached --quiet; then
          echo "üîÑ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          MOSCOW_TIME=$(TZ='Europe/Moscow' date '+%H:%M | %d.%m.%Y')
          git commit -m "ü§ñ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $MOSCOW_TIME"
          git push
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã"
        fi
