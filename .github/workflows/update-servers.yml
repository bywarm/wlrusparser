name: Update Configs Hourly

on:
  schedule:
    # –ö–∞–∂–¥—ã–π —á–∞—Å –≤ 0 –º–∏–Ω—É—Ç
    - cron: '0 * * * *'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches: [ main ]
    paths-ignore:
      - 'githubmirror/merged.txt'
      - 'githubmirror/wl.txt'
      - 'cloudflare-pages/working-servers.txt'
      - 'cloudflare-pages/simple-list.txt'
      - 'README.md'

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: write
    
    steps:
    - name: ‚¨áÔ∏è Checkout repository with token
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è rebase
    
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub requests urllib3
    
    - name: üöÄ Run merge script
      env:
        MY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üïê –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞..."
        python scripts/simple_merge.py
    
    - name: üíæ Commit and push changes
      run: |
        echo "üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
        
        if [ -f "githubmirror/merged.txt" ]; then
          CONFIG_COUNT=$(grep -c '^v[lm]ess://' githubmirror/merged.txt 2>/dev/null || echo "0")
          echo "üìä –ö–æ–Ω—Ñ–∏–≥–æ–≤ –≤ merged.txt: $CONFIG_COUNT"
        fi
        
        if [ -f "githubmirror/wl.txt" ]; then
          WL_CONFIG_COUNT=$(grep -c '^v[lm]ess://' githubmirror/wl.txt 2>/dev/null || echo "0")
          echo "üõ°Ô∏è –ö–æ–Ω—Ñ–∏–≥–æ–≤ –≤ wl.txt: $WL_CONFIG_COUNT"
        fi
        
        if [ -f "cloudflare-pages/simple-list.txt" ]; then
          SIMPLE_COUNT=$(grep -c '^#[0-9]\+\.' cloudflare-pages/simple-list.txt 2>/dev/null || echo "0")
          echo "üî¢ –ü—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–æ –≤ simple-list.txt: $SIMPLE_COUNT"
        fi
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config --local pull.rebase true
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git add githubmirror/merged.txt githubmirror/wl.txt \
                cloudflare-pages/working-servers.txt cloudflare-pages/simple-list.txt \
                README.md
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if git diff --cached --quiet; then
          echo "üîÑ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          exit 0
        fi
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç
        MOSCOW_TIME=$(TZ='Europe/Moscow' date '+%H:%M | %d.%m.%Y')
        git commit -m "ü§ñ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $MOSCOW_TIME"
        
        # –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º..."
        
        # –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—ã—Ç–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å pull —Å rebase
        if git pull --rebase origin main; then
          echo "‚úÖ Rebase —É—Å–ø–µ—à–µ–Ω"
        else
          echo "‚ö†Ô∏è Rebase –Ω–µ —É–¥–∞–ª—Å—è, –æ—Ç–º–µ–Ω—è–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Å–ª–∏—è–Ω–∏—è"
          git rebase --abort
          git pull origin main --strategy-option ours
        fi
        
        # –ü—ã—Ç–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å push
        echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
        MAX_RETRIES=3
        RETRY_DELAY=10
        
        for i in $(seq 1 $MAX_RETRIES); do
          echo "–ü–æ–ø—ã—Ç–∫–∞ $i –∏–∑ $MAX_RETRIES..."
          
          if git push origin main; then
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
            break
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ, –ø–æ–ø—ã—Ç–∫–∞ $i –Ω–µ —É–¥–∞–ª–∞—Å—å"
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "‚è≥ –ñ–¥–µ–º $RETRY_DELAY —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π..."
              sleep $RETRY_DELAY
              
              # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
              echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
              git pull origin main --rebase
            else
              echo "üí• –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å"
              exit 1
            fi
          fi
        done
